define(["jquery","core/ajax","core/notification","core/str","core/url","core/modal_factory","core/modal_events"],function(a,b,c,d,e,f,g){return{triggerSteps:0,assignSupporter:function(e,h){"undefined"==typeof h&&b.call([{methodname:"block_edusupport_get_potentialsupporters",args:{discussionid:e},done:function(h){try{h=JSON.parse(h)}catch(i){}console.log("block_edusupport_get_potentialsupporters",h);var j=Object.keys(h.supporters),k='<input type="hidden" value="'+e+'" />';k+="<select>";for(var l=0;l<j.length;l++){k+='<optgroup label="'+j[l]+'">';for(var m=0;m<h.supporters[j[l]].length;m++){var n=h.supporters[j[l]][m];k+='<option value="'+n.id+'"'+(n.selected?' selected="selected"':"")+">"+n.firstname+" "+n.lastname+"</option>"}k+="</optgroup>"}k+="</select>",f.create({title:d.get_string("select","core"),type:f.types.SAVE_CANCEL,body:k}).done(function(d){console.log("Created modal"),d.show(),d.getRoot().on(g.save,function(d){d.preventDefault();var e=a(this).find(".modal-body input").val(),f=a(this).find(".modal-body select").val(),g={discussionid:e,supporterid:f};b.call([{methodname:"block_edusupport_set_currentsupporter",args:g,done:function(a){console.log(a),1==a?top.location.reload():alert("Error: "+a)},fail:c.exception}])})})},fail:c.exception}])},closeIssue:function(a){console.log("closeIssue(discussionid)",a),b.call([{methodname:"block_edusupport_close_issue",args:{discussionid:a},done:function(a){console.log(a),1==a?top.location.reload():c.exception(a)},fail:c.exception}])},colorize:function(){var d=[];a("table.forumheaderlist tr.discussion td.starter a").each(function(){var b=a(this).attr("href").split("?d=");d[d.length]=b[1]});var e={discussionids:d};console.log("block_edusupport_colorize",e),b.call([{methodname:"block_edusupport_colorize",args:e,done:function(b){try{b=JSON.parse(b)}catch(c){}if(console.log(b),"undefined"!=typeof b.styles)for(var d=Object.keys(b.styles),e=0;e<d.length;e++){var f=d[e],g=b.styles[f];a('table.forumheaderlist tr.discussion td.starter a[href$="d='+f+'"]').closest("tr").attr("style",g)}},fail:c.exception}])},postBox:function(f){var g=this;if("undefined"!=typeof g.is_sending&&g.is_sending)return void console.log("Issue in queue, aborting");var h=a("#block_edusupport_create_form #id_subject").val(),i=a("#block_edusupport_create_form #id_contactphone").val(),j=a("#block_edusupport_create_form #id_description").val(),k=a('#block_edusupport_create_form input[name="forumid"]').val(),l=a("#block_edusupport_create_form #id_to_group").val(),m=a("#block_edusupport_create_form #id_postscreenshot").is(":checked"),n=a("#block_edusupport_create_form img#screenshot").attr("src"),o=top.location.href;if(h.length<3||j.length<5){var p=d.get_string("be_more_accurate","block_edusupport",{});return void a.when(p).done(function(a){c.alert("",a)})}g.is_sending=!0;var q=m&&"undefined"!=typeof n?n:"";console.log("block_edusupport_create_issue",{subject:h,description:j,forumid:k,to_group:l,image:q,url:o}),b.call([{methodname:"block_edusupport_create_issue",args:{subject:h,description:j,forumid:k,to_group:l,image:q,url:o,contactphone:i},done:function(a){console.log(a),f.hide(),parseInt(a)>0?d.get_strings([{key:"create_issue_success_title",component:"block_edusupport"},{key:"create_issue_success_description",component:"block_edusupport"},{key:"create_issue_success_goto",component:"block_edusupport"},{key:"create_issue_success_close",component:"block_edusupport"}]).done(function(b){c.confirm(b[0],b[1],b[2],b[3],function(){top.location.href=e.fileUrl("/mod/forum/discuss.php","?d="+a)})}).fail(c.exception):d.get_strings([{key:"create_issue_error_title",component:"block_edusupport"},{key:"create_issue_error_description",component:"block_edusupport"}]).done(function(a){c.alert(a[0],a[1])}).fail(c.exception),g.is_sending=!1},fail:c.exception}])},prepareBox:function(){console.log("Showing modal");var b=this,c=a(b.modal.body);c.find("#id_to_group>option").length<=1&&c.find("#id_to_group").parent().parent().css("display","none"),b.modal.setLarge(),b.modal.getRoot().on(g.save,function(a){b.postBox(b.modal),a.preventDefault()});var e=d.get_string("create_issue","block_edusupport",{});a.when(e).done(function(a){b.modal.setSaveButtonText(a)}),a("#id_postscreenshot").closest("div.fitem").css("display","none"),a("#screenshot").closest("div").css("display","none"),"undefined"!=typeof b.canvas&&b.prepareScreenshot(),b.modal.show()},prepareScreenshot:function(){var b=this,c=b.canvas.toDataURL(),d=a(b.modal.body);d.find("img#screenshot").attr("src",c),a("#screenshot").closest("div").css("display",void 0),a("#id_postscreenshot").closest("div.fitem").css("display",void 0),delete b.canvas},showBox:function(d){"undefined"==typeof d&&(d=0);var e=this;delete e.canvas,"undefined"!=typeof e.modal?e.prepareBox(d):(console.log("Fetching modal"),e.triggerSpinner(1),b.call([{methodname:"block_edusupport_create_form",args:{url:top.location.href,image:"",forumid:d},done:function(b){console.log("Got modal"),e.triggerSpinner(-1),a("#block_edusupport_create_form").remove(),f.create({type:f.types.SAVE_CANCEL,body:b,large:1}).done(function(a){console.log("Created modal"),e.modal=a,e.prepareBox()})},fail:c.exception}])),require(["block_edusupport/html2canvas"],function(a){console.log("Making screenshot"),a(document.body).then(function(a){console.log("Got screenshot"),e.canvas=a,"undefined"!=typeof e.modal&&e.prepareScreenshot()})})},triggerSpinner:function(b){MAIN=this,MAIN.triggerSteps+=b,MAIN.triggerSteps>0?0==a("body #edusupport-spinner").length&&a("body").append(a('<div id="edusupport-spinner" class="spinner-grid show"><div></div><div></div><div></div><div></div></div>')):a("#edusupport-spinner").remove()}}});