define(["jquery","core/ajax","core/notification","core/str","core/url","core/modal_factory","core/modal_events"],function(f,c,d,e,b,a,g){return{debug:1,modal:undefined,triggerSteps:0,assignSupporter:function(j,h){var i=this;if(i.debug>0){console.log("block_edusupport/main:assignSupporter(discussionid, userid)",j,h)}if(typeof h==="undefined"){console.log("ajax call");c.call([{methodname:"block_edusupport_get_potentialsupporters",args:{discussionid:j},done:function(m){try{m=JSON.parse(m)}catch(p){}if(i.debug>0){console.log("block_edusupport_external:block_edusupport_get_potentialsupporters",m)}var q=Object.keys(m.supporters);var l='<input type="hidden" value="'+j+'" />';l+="<select>";for(var n=0;n<q.length;n++){l+='<optgroup label="'+q[n]+'">';for(var k=0;k<m.supporters[q[n]].length;k++){var o=m.supporters[q[n]][k];l+='<option value="'+o.userid+'"'+((o.selected)?' selected="selected"':"")+">"+o.firstname+" "+o.lastname+"</option>"}l+="</optgroup>"}l+="</select>";a.create({title:e.get_string("select","core"),type:a.types.SAVE_CANCEL,body:l,}).done(function(r){console.log("Created modal");r.show();r.getRoot().on(g.save,function(u){u.preventDefault();var v=f(this).find(".modal-body input").val();var s=f(this).find(".modal-body select").val();var t={discussionid:v,supporterid:s};c.call([{methodname:"block_edusupport_set_currentsupporter",args:t,done:function(w){console.log(w);if(w==1){top.location.reload()}else{alert("Error: "+w)}},fail:d.exception}])})})},fail:d.exception}])}else{}},checkHasScreenshot:function(i){var h=this;if(h.debug>0){console.log("block_edusupport/main:checkHasScreenshot(c)",i)}if(f(i).closest("form").find("#screenshot").attr("src")==""){f(i).closest("form").find("#screenshot_ok").css("display","block")}else{f(i).closest("form").find("#screenshot_ok").css("display","none");f(i).closest("form").find("#screenshot").css("display",(f(i).is(":checked")?"inline":"none"))}},generateScreenshot:function(h){MAIN.modal.hide();require(["block_edusupport/html2canvas"],function(i){console.log("Making screenshot");i(document.body).then(function(j){console.log("Got screenshot");MAIN.canvas=j;if(typeof MAIN.modal!=="undefined"){MAIN.prepareScreenshot(h);MAIN.modal.show()}})})},injectHelpButton:function(){console.log("block_edusupport/main:injectHelpButton()");var h=f('<li class="nav-item">').append(f('<div class="popover-region collapsed">').append(f('<a href="#" class="nav-link d-inline-block popover-region-toggle position-relative">').attr("onclick",'require(["block_edusupport/main"], function(MAIN){ MAIN.showBox(); }); return false;').append(f('<i class="icon fa fa-medkit fa-fw">'))));f(h).insertBefore(f("#page-wrapper>.navbar div.usermenu").closest("li"))},injectReplyButtons:function(h){e.get_strings([{key:"reply",component:"forum"},]).done(function(i){f('a[href*="issue.php?discussion='+h+'&parent="]').remove();f("#page-blocks-edusupport-issue .forum-post-container>.forumpost").each(function(){var j=f(this).attr("data-post-id");if(f(this).find(".reply-"+j).length==0){f(this).find(".post-actions:first-child").append(f('<a data-region="post-action" class="btn btn-link reply-'+j+'" title="'+i[0]+'" aria-label="'+i[0]+'" role="menuitem" tabindex="-1">').html(i[0]).attr("href",b.relativeUrl("/blocks/edusupport/issue.php?discussion="+h+"&replyto="+j)))}})}).fail(d.exception)},closeIssue:function(h){console.log("closeIssue(discussionid)",h);c.call([{methodname:"block_edusupport_close_issue",args:{discussionid:h},done:function(i){console.log(i);if(i==1){top.location.href=b.relativeUrl("/blocks/edusupport/issues.php",{})}else{d.exception(i)}},fail:d.exception}])},colorize:function(){var i=[];f("table.forumheaderlist tr.discussion td.starter a").each(function(){var j=f(this).attr("href").split("?d=");i[i.length]=j[1]});var h={discussionids:i};console.log("block_edusupport_colorize",h);c.call([{methodname:"block_edusupport_colorize",args:h,done:function(j){try{j=JSON.parse(j)}catch(n){}console.log(j);if(typeof j.styles!=="undefined"){var m=Object.keys(j.styles);for(var k=0;k<m.length;k++){var o=m[k];var l=j.styles[o];f('table.forumheaderlist tr.discussion td.starter a[href$="d='+o+'"]').closest("tr").attr("style",l)}}},fail:d.exception}])},injectForwardButton:function(i,h){if(this.debug){console.log("block_edusupport/main:injectForwardButton(discussionid, isissue)",i,h)}if(typeof i==="undefined"){return}e.get_strings([{key:(typeof h!=="undefined"&&h)?"issue_revoke":"issue_assign_nextlevel",component:"block_edusupport"},]).done(function(j){f('#page-content div[role="main"] .discussionname').parent().prepend(f('<a href="#">').attr("onclick","require(['block_edusupport/main'], function(MAIN) { MAIN.injectForwardModal("+i+", "+h+"); }); return false;").attr("style","float: right").addClass("btn btn-secondary").html(j[0]))}).fail(d.exception)},injectForwardModal:function(i,h){e.get_strings([{key:"confirm",component:"core"},{key:(typeof h!=="undefined"&&h)?"issue_revoke":"issue_assign_nextlevel",component:"block_edusupport"},]).done(function(j){a.create({type:a.types.SAVE_CANCEL,title:j[0],body:j[1],}).done(function(l){var k=l.getRoot();k.on(g.save,function(){top.location.href=b.relativeUrl("/blocks/edusupport/forward_2nd_level.php",{d:i,revoke:h})});l.show()})}).fail(d.exception)},postBox:function(r){var i=this;if(typeof i.is_sending!=="undefined"&&i.is_sending){console.log("Issue in queue, aborting");return}if(i.debug>0){console.log("MAIN.postBox(modal)",r)}var q=f("#block_edusupport_create_form #id_subject").val();var l=f("#block_edusupport_create_form #id_contactphone").val();var s=f("#block_edusupport_create_form #id_description").val();var j=f("#block_edusupport_create_form #id_forum_group").val();var m=f("#block_edusupport_create_form #id_postto2ndlevel").prop("checked")?1:0;var o=f("#block_edusupport_create_form #id_postscreenshot").prop("checked")?1:0;var p=f("#block_edusupport_create_form img#screenshot").attr("src");var h=top.location.href;if(q.length<3||s.length<5){var k=e.get_string("be_more_accurate","block_edusupport",{});f.when(k).done(function(t){d.alert("",t)});return}i.is_sending=true;var n=(o&&typeof p!=="undefined")?p:"";if(i.debug>0){console.log("block_edusupport_create_issue",{subject:q,description:s,forum_group:j,postto2ndlevel:m,image:n,url:h})}c.call([{methodname:"block_edusupport_create_issue",args:{subject:q,description:s,forum_group:j,postto2ndlevel:m,image:n,url:h,contactphone:l},done:function(t){if(i.debug>0){console.log(t)}r.hide();if(parseInt(t)==-999){e.get_strings([{key:"create_issue_success_title",component:"block_edusupport"},{key:"create_issue_success_description_mail",component:"block_edusupport"},{key:"create_issue_success_close",component:"block_edusupport"},]).done(function(u){d.alert(u[0],u[1],u[2])}).fail(d.exception)}else{if(parseInt(t)>0){e.get_strings([{key:"create_issue_success_title",component:"block_edusupport"},{key:"create_issue_success_description",component:"block_edusupport"},{key:"create_issue_success_goto",component:"block_edusupport"},{key:"create_issue_success_close",component:"block_edusupport"},]).done(function(u){d.confirm(u[0],u[1],u[2],u[3],function(){top.location.href=b.fileUrl("/mod/forum/discuss.php","?d="+t)})}).fail(d.exception)}else{e.get_strings([{key:"create_issue_error_title",component:"block_edusupport"},{key:"create_issue_error_description",component:"block_edusupport"},]).done(function(u){d.alert(u[0],u[1])}).fail(d.exception)}}i.is_sending=false},fail:d.exception}])},prepareBox:function(){var j=this;if(j.debug>0){console.log("Showing modal")}var h=f(j.modal.body);if(h.find("#id_forum_group>option").length<=1){h.find("#id_forum_group").parent().parent().css("display","none")}j.modal.setLarge();j.modal.getRoot().on(g.save,function(k){j.postBox(j.modal);k.preventDefault()});var i=e.get_string("create_issue","block_edusupport",{});f.when(i).done(function(k){j.modal.setSaveButtonText(k)});f("#id_postscreenshot").closest("div.fitem").css("display","none");f("#screenshot").closest("div").css("display","none");j.modal.show()},prepareScreenshot:function(k){var j=this;var i=j.canvas.toDataURL();var h=f(j.modal.body);h.find("img#screenshot").attr("src",i);f("#screenshot").closest("div").css("display",undefined);f("#id_postscreenshot").closest("div.fitem").css("display",undefined);j.checkHasScreenshot(f("#id_postscreenshot"));delete (j.canvas)},showBox:function(i){if(typeof i==="undefined"){i=0}var h=this;delete (h.canvas);if(typeof h.modal!=="undefined"){h.prepareBox(i)}else{console.log("Fetching modal");h.triggerSpinner(1);c.call([{methodname:"block_edusupport_create_form",args:{url:top.location.href,image:"",forumid:i},done:function(j){console.log("Got modal");h.triggerSpinner(-1);f("#block_edusupport_create_form").remove();a.create({type:a.types.SAVE_CANCEL,body:j,large:1,}).done(function(k){console.log("Created modal");h.modal=k;h.prepareBox()})},fail:d.exception}])}},supportCourseMovedAlert:function(i,h){a.create({title:i,type:a.types.OK,body:h,}).done(function(j){j.show()})},triggerSpinner:function(h){MAIN=this;MAIN.triggerSteps+=h;if(MAIN.triggerSteps>0){if(f("body #edusupport-spinner").length==0){f("body").append(f('<div id="edusupport-spinner" class="spinner-grid show"><div></div><div></div><div></div><div></div></div>'))}}else{f("#edusupport-spinner").remove()}}}});