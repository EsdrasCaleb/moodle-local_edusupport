define(["jquery","core/ajax","core/notification","core/str","core/url","core/modal_factory","core/modal_events","core/templates"],function(g,c,e,f,b,a,h,d){return{debug:1,modal:undefined,triggerSteps:0,assignSupporter:function(j){var i=this;console.log("ajax call");c.call([{methodname:"local_edusupport_get_potentialsupporters",args:{discussionid:j},done:function(m){try{m=JSON.parse(m)}catch(p){}if(i.debug>0){console.log("local_edusupport_external:local_edusupport_get_potentialsupporters",m)}var q=Object.keys(m.supporters);var l='<input type="hidden" value="'+j+'" />';l+="<select>";for(var n=0;n<q.length;n++){l+='<optgroup label="'+q[n]+'">';for(var k=0;k<m.supporters[q[n]].length;k++){var o=m.supporters[q[n]][k];l+='<option value="'+o.userid+'"'+((o.selected)?' selected="selected"':"")+">"+o.firstname+" "+o.lastname+"</option>"}l+="</optgroup>"}l+="</select>";a.create({title:f.get_string("select","core"),type:a.types.SAVE_CANCEL,body:l,}).done(function(r){console.log("Created modal");r.show();r.getRoot().on(h.save,function(u){u.preventDefault();var v=g(this).find(".modal-body input").val();var s=g(this).find(".modal-body select").val();var t={discussionid:v,supporterid:s};c.call([{methodname:"local_edusupport_set_currentsupporter",args:t,done:function(w){console.log(w);if(w==1){top.location.reload()}else{alert("Error: "+w)}},fail:e.exception}])})})},fail:e.exception}])},checkHasScreenshot:function(j){var i=this;if(i.debug>0){console.log("local_edusupport/main:checkHasScreenshot(c)",j)}if(g(j).closest("form").find("#screenshot").attr("src")==""){g(j).closest("form").find("#screenshot_ok").css("display","block")}else{g(j).closest("form").find("#screenshot_ok").css("display","none");g(j).closest("form").find("#screenshot").css("display",(g(j).is(":checked")?"inline":"none"));g(j).closest("form").find("#screenshot_new").css("display",(g(j).is(":checked")?"block":"none"))}},generateScreenshot:function(i){MAIN.modal.hide();require(["local_edusupport/html2canvas"],function(j){console.log("Making screenshot");j(document.body).then(function(k){console.log("Got screenshot");MAIN.canvas=k;if(typeof MAIN.modal!=="undefined"){MAIN.prepareScreenshot(i);MAIN.modal.show()}})})},injectHelpButton:function(){console.log("local_edusupport/main:injectHelpButton()");c.call([{methodname:"local_edusupport_get_extralinks",args:{},done:function(i){g(i).insertBefore(g(".nav .usermenu"))},fail:e.exception}])},injectReplyButtons:function(i){f.get_strings([{key:"reply",component:"forum"},]).done(function(j){g('a[href*="issue.php?discussion='+i+'&parent="]').remove();g('a[href*="issue.php?discussion='+i+'&delete="]').remove();g('a[href*="post.php?prune="]').remove();g(".forum-post-container>.forumpost").each(function(){var k=g(this).attr("data-post-id");if(g(this).find(".reply-"+k).length==0){g(this).find(".post-actions:first-child").append(g('<a data-region="post-action" class="btn btn-link reply-'+k+'" title="'+j[0]+'" aria-label="'+j[0]+'" role="menuitem" tabindex="-1">').html(j[0]).attr("href",b.relativeUrl("/local/edusupport/issue.php?discussion="+i+"&replyto="+k)))}})}).fail(e.exception)},closeIssue:function(i){console.log("closeIssue(discussionid)",i);c.call([{methodname:"local_edusupport_close_issue",args:{discussionid:i},done:function(j){console.log(j);if(j==1){top.location.href=b.relativeUrl("/local/edusupport/issues.php",{})}else{e.exception(j)}},fail:e.exception}])},colorize:function(){var j=[];g("table.forumheaderlist tr.discussion td.starter a").each(function(){var k=g(this).attr("href").split("?d=");j[j.length]=k[1]});var i={discussionids:j};console.log("local_edusupport_colorize",i);c.call([{methodname:"local_edusupport_colorize",args:i,done:function(k){try{k=JSON.parse(k)}catch(o){}console.log(k);if(typeof k.styles!=="undefined"){var n=Object.keys(k.styles);for(var l=0;l<n.length;l++){var p=n[l];var m=k.styles[p];g('table.forumheaderlist tr.discussion td.starter a[href$="d='+p+'"]').closest("tr").attr("style",m)}}},fail:e.exception}])},faqtoogle:function(){if(g("input#id_faqread:not(.autochecked)").length){g("#create_issue_input").toggle();g("#local_edusupport_create_form .fdescription.required").toggle();g("input#id_faqread").click(function(){g("#create_issue_input").toggle();g("#local_edusupport_create_form .fdescription.required").toggle()})}},injectForwardButton:function(j,i){if(this.debug){console.log("local_edusupport/main:injectForwardButton(discussionid, isissue)",j,i)}if(typeof j==="undefined"){return}f.get_strings([{key:(typeof i!=="undefined"&&i)?"issue_revoke":"issue_assign_nextlevel",component:"local_edusupport"},]).done(function(k){g('#page-content div[role="main"] .discussionname').parent().prepend(g('<a href="#">').attr("onclick","require(['local_edusupport/main'], function(MAIN) { MAIN.injectForwardModal("+j+", "+i+"); }); return false;").attr("style","float: right").addClass("btn btn-secondary").html(k[0]))}).fail(e.exception)},injectTest:function(){var i=g(".discussionname");if(i.text().substr(0,2)=="! "){i.addClass("alert-warning")}if(i.text().substr(0,2)=="!!"){i.addClass("alert-danger")}},injectForwardModal:function(j,i){f.get_strings([{key:"confirm",component:"core"},{key:(typeof i!=="undefined"&&i)?"issue_revoke":"issue_assign_nextlevel",component:"local_edusupport"},]).done(function(k){a.create({type:a.types.SAVE_CANCEL,title:k[0],body:k[1],}).done(function(m){var l=m.getRoot();l.on(h.save,function(){top.location.href=b.relativeUrl("/local/edusupport/forward_2nd_level.php",{d:j,revoke:i})});m.show()})}).fail(e.exception)},postBox:function(t){var j=this;if(typeof j.is_sending!=="undefined"&&j.is_sending){console.log("Issue in queue, aborting");return}if(j.debug>0){console.log("MAIN.postBox(modal)",t)}var s=g("#local_edusupport_create_form #id_subject").val();var n=g("#local_edusupport_create_form #id_contactphone").val()||"";console.log(n);var u=g("#local_edusupport_create_form #id_description").val();var k=g("#local_edusupport_create_form #id_forum_group").val();var o=g("#local_edusupport_create_form #id_postto2ndlevel").prop("checked")?1:0;var q=g("#local_edusupport_create_form #id_postscreenshot").prop("checked")?1:0;var r=g("#local_edusupport_create_form img#screenshot").attr("src");var m=g("#local_edusupport_create_form #id_faqread").prop("checked")?1:0;var i=top.location.href;if(m==0){var l=f.get_string("faqread","local_edusupport",{});g.when(l).done(function(v){e.alert("",v)});return}if(s.length<3||u.length<5){var l=f.get_string("be_more_accurate","local_edusupport",{});g.when(l).done(function(v){e.alert("",v)});return}j.is_sending=true;var p=(q&&typeof r!=="undefined")?r:"";if(j.debug>0){console.log("local_edusupport_create_issue",{subject:s,description:u,forum_group:k,postto2ndlevel:o,image:p,url:i})}c.call([{methodname:"local_edusupport_create_issue",args:{subject:s,description:u,forum_group:k,postto2ndlevel:o,image:p,url:i,contactphone:n},done:function(v){if(j.debug>0){console.log(v)}t.hide();var w="";if(typeof v.responsibles!=="undefined"){w+="<ul>";for(var x=0;x<v.responsibles.length;x++){var y=v.responsibles[x];if(typeof y.userid!=="undefined"&&y.userid>0){w+='<li><a href="'+b.fileUrl("/user","view.php?id="+y.userid)+'" target="_blank">'+y.name+"</a></li>"}else{if(typeof y.email!=="undefined"&&y.email!=""){w+='<li><a href="mailto:'+y.email+'">'+y.name+"</a></li>"}else{w+="<li>"+y.name+"</li>"}}}w+="</ul>"}if(typeof v.discussionid!=="undefined"&&parseInt(v.discussionid)==-999){f.get_strings([{key:"create_issue_success_title",component:"local_edusupport"},{key:"create_issue_success_description_mail",component:"local_edusupport"},{key:"create_issue_success_responsibles",component:"local_edusupport"},{key:"create_issue_success_close",component:"local_edusupport"},]).done(function(z){var A=z[1];if(w!=""){A=z[2]+w}e.alert(z[0],A,z[3])}).fail(e.exception)}else{if(typeof v.discussionid!=="undefined"&&parseInt(v.discussionid)>0){f.get_strings([{key:"create_issue_success_title",component:"local_edusupport"},{key:"create_issue_success_description",component:"local_edusupport"},{key:"create_issue_success_responsibles",component:"local_edusupport"},{key:"create_issue_success_goto",component:"local_edusupport"},{key:"create_issue_success_close",component:"local_edusupport"},]).done(function(z){var A=z[1];if(w!=""){A=z[2]+w}e.confirm(z[0],A,z[3],z[4],function(){top.location.href=b.fileUrl("/mod/forum","discuss.php?d="+v.discussionid)})}).fail(e.exception)}else{f.get_strings([{key:"create_issue_error_title",component:"local_edusupport"},{key:"create_issue_error_description",component:"local_edusupport"},]).done(function(z){e.alert(z[0],z[1])}).fail(e.exception)}}j.is_sending=false},fail:e.exception}])},prepareBox:function(){var k=this;if(k.debug>0){console.log("Showing modal")}var i=g(k.modal.body);if(i.find("#id_forum_group>option").length<=1){i.find("#id_forum_group").parent().parent().css("display","none")}k.modal.setLarge();k.modal.getRoot().on(h.save,function(l){k.postBox(k.modal);l.preventDefault()});var j=f.get_string("create_issue","local_edusupport",{});g.when(j).done(function(l){k.modal.setSaveButtonText(l)});k.modal.show()},prepareScreenshot:function(l){var k=this;var j=k.canvas.toDataURL();var i=g(k.modal.body);i.find("img#screenshot").attr("src",j);g("#screenshot").closest("div").css("display",undefined);g("#id_postscreenshot").closest("div.fitem").css("display",undefined);k.checkHasScreenshot(g("#id_postscreenshot"));delete (k.canvas)},showBox:function(j){if(typeof j==="undefined"){j=0}var i=this;delete (i.canvas);if(typeof i.modal!=="undefined"){i.prepareBox(j)}else{console.log("Fetching modal");i.triggerSpinner(1);c.call([{methodname:"local_edusupport_create_form",args:{url:top.location.href,image:"",forumid:j},done:function(k){console.log("Got modal");i.triggerSpinner(-1);g("#local_edusupport_create_form").remove();a.create({type:a.types.SAVE_CANCEL,body:k,large:1,}).done(function(l){console.log("Created modal");i.modal=l;i.prepareBox();i.faqtoogle()})},fail:e.exception}])}},showSupporter:function(j){if(typeof j==="undefined"){j=0}var i=this;delete (i.canvas);if(typeof i.modal!=="undefined"){i.prepareBox(j)}else{console.log("Fetching modal");i.triggerSpinner(1);c.call([{methodname:"local_edusupport_create_form",args:{url:top.location.href,image:"",forumid:j},done:function(k){console.log("Got modal");i.triggerSpinner(-1);g("#local_edusupport_create_form").remove();a.create({type:a.types.SAVE_CANCEL,body:k,large:1,}).done(function(l){console.log("Created modal");i.modal=l;i.prepareBox()})},fail:e.exception}])}},supportCourseMovedAlert:function(j,i){a.create({title:j,type:a.types.OK,body:i,}).done(function(k){k.show()})},triggerSpinner:function(i){MAIN=this;MAIN.triggerSteps+=i;if(MAIN.triggerSteps>0){if(g("body #edusupport-spinner").length==0){g("body").append(g('<div id="edusupport-spinner" class="spinner-grid show"><div></div><div></div><div></div><div></div></div>'))}}else{g("#edusupport-spinner").remove()}}}});